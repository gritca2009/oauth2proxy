services:
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:latest
    container_name: oauth2-proxy
    restart: unless-stopped
    ports:
      - "${OAUTH2_PROXY_PORT}:${OAUTH2_PROXY_PORT}"
    environment:
      OAUTH2_PROXY_PROVIDER: oidc
      # Logging-Einstellungen f√ºr oauth2-proxy
      OAUTH2_PROXY_STANDARD_LOGGING: "true"
      OAUTH2_PROXY_AUTH_LOGGING: "true"
      OAUTH2_PROXY_HTTP_LOGGING: "true"
      # client
      OAUTH2_PROXY_CLIENT_ID: ${OAUTH2_PROXY_CLIENT_ID}
      OAUTH2_PROXY_CLIENT_SECRET: ${OAUTH2_PROXY_CLIENT_SECRET}
      OAUTH2_PROXY_OIDC_ISSUER_URL: ${OAUTH2_PROXY_ISSUER}/realms/${OAUTH2_PROXY_REALM}

      # --- Listener ---
      OAUTH2_PROXY_HTTP_ADDRESS: 0.0.0.0:${OAUTH2_PROXY_PORT}

      # --- Externe URL  ---
      OAUTH2_PROXY_REDIRECT_URL: ${OAUTH2_PROXY_RESOURCE_APP_URL}

      # --- Session / Cookies ---
      OAUTH2_PROXY_COOKIE_SECRET: ${OAUTH2_PROXY_COOKIE_SECRET}
      OAUTH2_PROXY_COOKIE_SECURE: "true"
      OAUTH2_PROXY_COOKIE_SAMESITE: "lax"

      # --- Auth ---
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"
      OAUTH2_PROXY_SCOPE: "openid profile email"

      # --- Weiterleitung zur App ---
      OAUTH2_PROXY_UPSTREAMS: http://resource-app:${OAUTH2_PROXY_RESOURCE_APP_PORT}/
      OAUTH2_PROXY_PASS_AUTHORIZATION_HEADER: "true"
      OAUTH2_PROXY_SET_XAUTHREQUEST: "true"
      OAUTH2_PROXY_PASS_ACCESS_TOKEN: "true"

  resource-app:
    build:
      context: ./resource-app
      args:
        - OAUTH2_PROXY_RESOURCE_APP_PORT=${OAUTH2_PROXY_RESOURCE_APP_PORT}
        - OAUTH2_PROXY_AUDIENCE=${OAUTH2_PROXY_AUDIENCE}
        - OAUTH2_PROXY_ISSUER_URL=${OAUTH2_PROXY_ISSUER_URL}
    container_name: resource-app
    restart: unless-stopped
    expose:
      - "${OAUTH2_PROXY_RESOURCE_APP_PORT}"
    environment:
      SHOW_TOKEN: "true"
